
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Link Sign In - PickleRadar</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
      }

      .container {
        background: white;
        padding: 48px 40px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        text-align: center;
        max-width: 480px;
        width: 100%;
      }

      .logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 24px;
        background: #667eea;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
      }

      h1 {
        color: #1a1a1a;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 12px;
        line-height: 1.3;
      }

      p {
        color: #666;
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 8px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        animation: spin 1s linear infinite;
        margin: 32px auto 24px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .success-icon {
        font-size: 64px;
        margin-bottom: 16px;
      }

      .error-icon {
        font-size: 64px;
        margin-bottom: 16px;
      }

      .footer {
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e5e5e5;
        color: #999;
        font-size: 14px;
      }

      .button {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 14px 32px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin-top: 24px;
        transition: background 0.2s;
      }

      .button:hover {
        background: #5568d3;
      }

      @media (max-width: 480px) {
        .container {
          padding: 32px 24px;
        }

        h1 {
          font-size: 24px;
        }

        p {
          font-size: 15px;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="logo">üèì</div>
      <div class="spinner"></div>
      <h1>Signing you in...</h1>
      <p>Please wait while we verify your magic link.</p>
      <div class="footer">Powered by Lopez Innovations LLC</div>
    </div>

    <script>
      // Initialize Supabase client
      const { createClient } = window.supabase;
      const supabaseClient = createClient(
        "https://biczbxmaisdxpcbplddr.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpY3pieG1haXNkeHBjYnBsZGRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NzY5NzUsImV4cCI6MjA1MjU1Mjk3NX0.Xt_Ry_Ot0Ov_Uy3Xt_Ry_Ot0Ov_Uy3Xt_Ry_Ot0Ov_Uy3"
      );

      async function run() {
        try {
          console.log('Magic link page loaded');
          console.log('Current URL:', window.location.href);
          
          // Exchange the token from the URL for a session
          console.log('Exchanging code for session...');
          const { data, error } = await supabaseClient.auth.exchangeCodeForSession(
            window.location.href
          );

          if (error) {
            console.error("Token exchange error:", error);
            
            // Show error message
            document.querySelector('.container').innerHTML = `
              <div class="logo">üèì</div>
              <div class="error-icon">‚ùå</div>
              <h1>Invalid or expired link</h1>
              <p>Your magic link has expired or is no longer valid.</p>
              <p style="margin-top: 16px;">Please request a new magic link from the PickleRadar app.</p>
              <div class="footer">Powered by Lopez Innovations LLC</div>
            `;
            return;
          }

          console.log('Session established successfully:', data);
          
          // Show success message
          document.querySelector('.container').innerHTML = `
            <div class="logo">üèì</div>
            <div class="success-icon">‚úÖ</div>
            <h1>You're signed in!</h1>
            <p>Welcome back to PickleRadar.</p>
            <p style="margin-top: 12px;">Opening the app...</p>
            <div class="footer">Powered by Lopez Innovations LLC</div>
          `;
          
          // Wait a moment, then deep link back to the app
          setTimeout(() => {
            console.log('Attempting to deep link to app...');
            window.location.href = "natively://magic-link";
            
            // Show fallback message after 2 seconds if deep link didn't work
            setTimeout(() => {
              document.querySelector('.container').innerHTML = `
                <div class="logo">üèì</div>
                <div class="success-icon">‚úÖ</div>
                <h1>You're signed in!</h1>
                <p>Welcome back to PickleRadar.</p>
                <p style="margin-top: 20px; color: #999; font-size: 14px;">
                  If the app didn't open automatically, please open it manually.
                </p>
                <a href="natively://magic-link" class="button">Open PickleRadar</a>
                <div class="footer">Powered by Lopez Innovations LLC</div>
              `;
            }, 2000);
          }, 500);
          
        } catch (err) {
          console.error(err);
          
          // Show error message
          document.querySelector('.container').innerHTML = `
            <div class="logo">üèì</div>
            <div class="error-icon">‚ùå</div>
            <h1>Something went wrong</h1>
            <p>An unexpected error occurred while processing your request.</p>
            <p style="margin-top: 16px;">Please try again or contact support if the problem persists.</p>
            <div class="footer">Powered by Lopez Innovations LLC</div>
          `;
        }
      }

      // Run the magic link handler when page loads
      run();
    </script>
  </body>
</html>
